#include "catch2/catch.hpp"

#include "share/scream_types.hpp"
#include "share/util/scream_utils.hpp"
#include "share/scream_kokkos.hpp"
#include "share/scream_pack.hpp"
#include "physics/p3/p3_functions.hpp"
#include "physics/p3/p3_functions_f90.hpp"
#include "share/util/scream_kokkos_utils.hpp"
#include "share/util/scream_arch.hpp"

#include "p3_unit_tests_common.hpp"

#include <thread>
#include <array>
#include <algorithm>
#include <random>

namespace scream {
namespace p3 {
namespace unit_test {

/*
 * Unit-tests for p3_functions.
 */
template <typename D>
struct UnitWrap::UnitTest<D>::TestP3Func
{

  KOKKOS_FUNCTION  static void saturation_tests(const Scalar& temperature, const Scalar& pressure, const Scalar& correct_sat_ice_p,
    const Scalar& correct_sat_liq_p, const Scalar&  correct_mix_ice_r, const Scalar& correct_mix_liq_r, int& errors ){

    const Spack temps(temperature);
    const Spack pres(pressure);

    Spack sat_ice_p = Functions::polysvp1(temps, true);
    Spack sat_liq_p = Functions::polysvp1(temps, false);

    Spack mix_ice_r = Functions::qv_sat(temps, pres, true);
    Spack mix_liq_r = Functions::qv_sat(temps, pres, false);

    // The correct results were computed with double precision, so we need
    // significantly greater tolerance for single precision.
    Scalar tol = (util::is_single_precision<Scalar>::value || util::OnGpu<ExeSpace>::value) ? C::Tol*100 : C::Tol;

    for(int s = 0; s < sat_ice_p.n; ++s){
      // Test vapor pressure
      if (abs(sat_ice_p[s] - correct_sat_ice_p) > tol ) {errors++;}
      if (abs(sat_liq_p[s] - correct_sat_liq_p) > tol)  {errors++;}
      //Test mixing-ratios
      if (abs(mix_ice_r[s] -  correct_mix_ice_r) > tol ) {errors++;}
      if (abs(mix_liq_r[s] -  correct_mix_liq_r) > tol ) {errors++;}
    }
  }

  static void run()
  {
    int nerr = 0;
    TeamPolicy policy(util::ExeSpaceUtils<ExeSpace>::get_default_team_policy(1, 1));
    Kokkos::parallel_reduce("TestTableIce::run", policy, KOKKOS_LAMBDA(const MemberType& team, int& errors) {

      errors = 0;
      const auto tmelt = C::Tmelt;
      // Test values @ the melting point of H20 @ 1e5 Pa
      saturation_tests(tmelt, 1e5, 610.7960763188032, 610.7960763188032,
         0.003822318507864685,  0.003822318507864685, errors);

      //Test vaules @ 243.15K @ 1e5 Pa
      saturation_tests(243.15, 1e5, 37.98530141245404, 50.98455924912173,
         0.00023634717905493638,  0.0003172707211143376, errors);

      //Test values @ 303.15 @ 1e5 Pa
      saturation_tests(303.15, 1e5, 4242.757341329608, 4242.757341329608,
        0.0275579183092878, 0.0275579183092878, errors);

    }, nerr);

    Kokkos::fence();
    REQUIRE(nerr == 0);
  }
};

  
  ///BALLI-new code
  
  template <typename D>
  struct UnitWrap::UnitTest<D>::TestP3UpdatePrognosticIce
  {
  
     
    KOKKOS_FUNCTION static void  update_prognostic_ice_unit_bfb_tests(){
      using KTH = KokkosTypes<HostDevice>;
      
      static constexpr Int max_pack_size = 16;
      
      REQUIRE(Spack::n <= max_pack_size);
      
      //fortran generated data is input to the following 
      // Jim's print statement for fortran code
      //print '("JGFF get_cloud_dsd2: nc=",ES20.12," mu_c=",ES20.12," nu=",ES20.12," lamc=",ES20.12," cdist=",ES20.12," cdist1=",ES20.12)', nc, mu_c, nu, lamc, cdist, cdist1

      P3UpdatePrognosticIceData pupidc[max_pack_size] = {
	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},


	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},


	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},


	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, 1, 0, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

	{ 4.9078102252657532E-019, 5.9698869870615695E-009, 0.0000000000000000, 3796125.0713374666, 1.7736894054953034E-004,
	  0.0000000000000000, 1.4300045023665814E-033, 8.1978258403749801E-026, 3.0430945682517439E-011, 3.4778223637162733E-004,
	  0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 5.1385646807762583E-007, 
	  0.0000000000000000, 0.0000000000000000, 2.7052763117748554E-002, 0.0000000000000000, 1.9208860554273338E-010,
	  1.0686413520835873, 333700.00000000000, 2834700.0000000000, true, false, 1800.0000000000000, 0.20000000000000001,
	  453.11687137025223, 287.20419568524414, 5.0000000000000001E-003, 6.4285714285714288E-005, 123444710.42445230,
	  7.3684210526315801E-006, 1000000.0000000000, 1.0000000000000000E-004, 1000000.0000000000, 6.4285714285714288E-005,
	  1.0000000000000000E-002},

      };
      
      // Sync to device
      KTH::view_1d<P3UpdatePrognosticIceData> pupidc_host("pupidc_host", Spack::n);
      view_1d<P3UpdatePrognosticIceData> pupidc_device("pupidc_host", Spack::n);
      
      // This copy only copies the input variables.
      std::copy(&pupidc[0], &pupidc[0] + Spack::n, pupidc_host.data());
      Kokkos::deep_copy(pupidc_device, pupidc_host);

      // Get data from fortran
      //for (Int i = 0; i < max_pack_size; ++i) {
      update_prognostic_ice(pupidc[1]);
	//}
    
      
    }
  
    static void run_bfb(){
      update_prognostic_ice_unit_bfb_tests();
    }
    

  };//TestP3UpdatePrognosticIce
  
  
    //---balli code changes above
  
  
  
  
}//namespace unit_test 
}//namespace p3 
}//namespace scream 

namespace {

TEST_CASE("p3_functions", "[p3_functions]")
{
  scream::p3::unit_test::UnitWrap::UnitTest<scream::DefaultDevice>::TestP3Func::run();
  
  scream::p3::unit_test::UnitWrap::UnitTest<scream::DefaultDevice>::TestP3UpdatePrognosticIce::run_bfb();

}

} // namespace
